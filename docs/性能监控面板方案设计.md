# 性能监控面板方案设计文档

## 📋 方案概述

本文档记录了在BMT-Central-SDK中实现统一性能监控面板的方案讨论和设计结果。

## 🎯 项目背景

BMT-Central-SDK已具备完整的性能监控能力，包括：
- Web Vitals监控（LCP、FID、CLS等）
- 导航时间分析
- 资源加载监控
- 长任务检测
- FPS监控
- 内存使用监控
- 网络质量检测

现有功能通过`Perf`类统一管理，但缺乏直观的展示界面。需要实现一个可视化的性能监控面板，让用户可以实时查看性能数据。

## 📊 方案比较与选择

### 方案一：SDK内置React面板 ⭐ **已选择**
**核心理念**：在SDK中集成React组件面板，作为SDK的一部分，用户接入SDK时面板可直接在应用上呈现。

#### 优势
- ✅ 用户体验佳：只需引入SDK就能看到可视化面板
- ✅ 集成度高：面板可直接消费SDK内部的性能数据流
- ✅ 实时性好：无需额外的数据传输，直接访问内部状态
- ✅ 定制性强：可根据SDK功能定制专属展示方式
- ✅ 开发友好：采用无限列表形式展示大量性能数据

#### 技术实现要点
- React版本兼容性处理（Peer Dependencies或运行时检测）
- 组件动态注入机制
- 虚拟滚动技术实现无限列表
- 样式隔离避免污染用户应用
- 性能监控对面板渲染的影响控制

#### 核心组件架构
```
PerfPanel/
├── PerfPanel.tsx          # 主面板组件
├── components/
│   ├── MetricCard.tsx     # 核心指标卡片
│   ├── DataList.tsx       # 无限列表（虚拟滚动）
│   ├── Chart.tsx          # 实时图表
│   └── Controls.tsx       # 控制面板
├── hooks/
│   ├── usePerfData.ts     # 性能数据流Hook
│   └── useVirtualScroll.ts # 虚拟滚动Hook
└── styles/
    └── PerfPanel.css      # 隔离样式文件
```

### 方案二：独立监控面板应用
**理念**：创建独立的Web应用，通过API获取性能数据。

#### 优势
- 功能强大，可做深度分析
- 支持历史数据存储和对比
- 丰富的图表和分析功能

#### 劣势
- 用户需要额外部署和维护
- 数据传输延迟
- 集成复杂度较高

### 方案三：浏览器DevTools插件
**理念**：开发Chrome/Firefox DevTools扩展。

#### 优势
- 与开发者工具无缝集成
- 性能开销最小
- 专业开发者友好

#### 劣势
- 用户群体有限（主要面向开发者）
- 插件安装和更新较为复杂

### 方案四：SDK内置轻量面板（非React）
**理念**：使用原生DOM操作实现轻量级面板。

#### 优势
- 无框架依赖
- 包体积最小
- 兼容性最好

#### 劣势
- 开发效率低
- UI表现力有限
- 维护困难

## 🚀 实施方案设计

### 1. SDK入口扩展

```typescript
// Perf类增加面板相关方法
export class Perf {
  static enablePerfPanel(options?: PerfPanelOptions): void {
    // 检测React环境 -> 注入面板组件 -> 建立数据流连接
  }

  static showPerfPanel(): void {
    // 显示面板
  }

  static hidePerfPanel(): void {
    // 隐藏面板
  }
}

// 使用示例
Perf.init({
  enablePerfPanel: true,  // 启用性能面板
  perfPanelOptions: {
    position: 'bottom-right',  // 面板位置
    theme: 'dark',            // 主题
    autoShow: true           // 自动显示
  }
})
```

### 2. 核心技术难点解决方案

#### React依赖处理
```typescript
// 方案A：Peer Dependencies（推荐）
"peerDependencies": {
  "react": ">=16.8.0",
  "react-dom": ">=16.8.0"
}

// 方案B：运行时检测
const React = window.React || global.React
if (!React) {
  console.warn('PerfPanel需要React环境，请确保应用中已安装React')
  return
}
```

#### 组件注入机制
```typescript
const injectPerfPanel = () => {
  if (!document.getElementById('bmt-perf-panel')) {
    const panelRoot = document.createElement('div')
    panelRoot.id = 'bmt-perf-panel'
    document.body.appendChild(panelRoot)

    // 使用用户的React渲染面板
    const root = ReactDOM.createRoot(panelRoot)
    root.render(<PerfPanel />)
  }
}
```

#### 无限列表实现
```typescript
const PerfDataList = () => {
  const [data, setData] = useState([])
  const [visibleRange, setVisibleRange] = useState({start: 0, end: 50})

  // 订阅SDK的性能数据流
  useEffect(() => {
    const unsubscribe = Perf.subscribeToMetrics((metric) => {
      setData(prev => [metric, ...prev])
    })
    return unsubscribe
  }, [])

  // 虚拟滚动逻辑
  return (
    <VirtualizedList
      data={data}
      visibleRange={visibleRange}
      itemHeight={40}
      containerHeight={400}
    />
  )
}
```

### 3. 数据流设计

```typescript
// 内部数据管理器
class PerfDataManager {
  private data: PerfMetric[] = []
  private listeners: Set<(metrics: PerfMetric[]) => void> = new Set()

  addMetric(metric: PerfMetric) {
    this.data.unshift(metric) // 新数据插入到开头
    this.listeners.forEach(listener => listener(this.data))
  }

  subscribe(listener: (metrics: PerfMetric[]) => void) {
    this.listeners.add(listener)
    return () => this.listeners.delete(listener)
  }
}
```

## 🎨 功能规划

### 核心功能
- [ ] 实时性能指标展示（LCP、FID、CLS等）
- [ ] 无限列表展示历史数据（虚拟滚动）
- [ ] 实时图表（FPS、内存使用趋势）
- [ ] 性能问题告警提示
- [ ] 面板拖拽调整位置
- [ ] 快捷键控制显示/隐藏

### 扩展功能
- [ ] 数据导出功能（JSON、CSV）
- [ ] 性能对比分析
- [ ] 自定义指标配置
- [ ] 主题切换
- [ ] 移动端适配

## ⚠️ 技术风险评估

### 高风险项
1. **React版本兼容性**：不同用户使用不同React版本
2. **样式污染**：面板样式影响用户应用
3. **性能影响**：面板渲染对性能监控的准确性影响

### 缓解措施
1. **版本兼容**：使用Peer Dependencies声明依赖范围，支持多个版本
2. **样式隔离**：使用CSS Modules或Shadow DOM
3. **性能监控**：面板本身性能数据不计入监控统计

## 📅 开发计划

### Phase 1: 基础框架（2周）
- [ ] React环境检测和注入机制
- [ ] 基础面板组件结构
- [ ] SDK数据流集成

### Phase 2: 核心功能（3周）
- [ ] 核心指标卡片展示
- [ ] 无限列表实现（虚拟滚动）
- [ ] 实时图表组件

### Phase 3: 用户体验（2周）
- [ ] 样式优化和主题支持
- [ ] 交互功能（拖拽、快捷键）
- [ ] 响应式设计

### Phase 4: 高级功能（2周）
- [ ] 数据导出
- [ ] 性能分析工具
- [ ] 配置选项扩展

## 🔧 技术栈选择

- **UI框架**：React 16.8+ (Hooks)
- **状态管理**：React useState/useEffect
- **样式方案**：CSS Modules + CSS Variables
- **图表库**：考虑轻量级方案或自实现
- **虚拟滚动**：react-window 或自实现
- **构建工具**：保持与SDK一致的构建配置

## 📋 验收标准

### 功能验收
- [ ] 用户只需引入SDK即可看到性能面板
- [ ] 面板展示所有核心性能指标
- [ ] 无限列表流畅展示大量数据
- [ ] 不影响用户应用的正常运行

### 性能验收
- [ ] 面板本身性能开销 < 5%
- [ ] 内存使用控制在合理范围内
- [ ] 在低性能设备上仍能正常工作

### 兼容性验收
- [ ] 支持React 16.8+所有版本
- [ ] 在主流浏览器中正常工作
- [ ] 不与用户应用样式冲突

---

## 📝 更新记录

- **2024-01-XX**: 方案讨论和设计完成
- **选择方案**: SDK内置React面板（方案一）
- **核心特色**: 无限列表展示 + 实时数据流
- **技术重点**: React环境检测 + 组件注入 + 虚拟滚动

---

**文档状态**: ✅ 方案已确认，开始进入开发阶段
