# 包引用与发布全链路与 exports/types 深解

## 1. 为何能用 @platform/sdk-core 这样引用
- 包名即入口标识：`package.json.name: "@platform/sdk-core"`，Node/打包器据此在 `node_modules` 定位包。
- 工作区解析（开发态）：`playground` 里依赖写 `workspace:*`，pnpm 在 Monorepo 内用本地链接代替发布安装，因此可直接 `import '@platform/sdk-core'`。
- 导出契约：每包 `package.json` 的 `exports` 与 `types` 指向 JS 和声明文件，保证“稳定入口 + 类型提示”，并限制深度导入路径，确保 API 稳定。

## 2. package.json 中的 exports 与 types

### 2.1 exports 的作用
- 定义“可见的导出入口”和按条件分发的文件映射，屏蔽内部实现文件，禁止随意深引。
- 支持子路径导出与多条件（如 `import`/`require`、`types`、`browser`、`node`）。
- 解析优先级：Node 与现代打包器优先使用 `exports`；若无 `exports`，才回落到 `module`/`main`。

示例（精简）：
```json
{
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./react": {
      "import": "./dist/react.js",
      "types": "./dist/react.d.ts"
    },
    "./vue": {
      "import": "./dist/vue.js",
      "types": "./dist/vue.d.ts"
    }
  }
}
```
- “主入口”由 `"."` 指向；子路径 `@platform/adapters/react`、`@platform/adapters/vue` 通过子路径导出暴露。
- `"types"` 条目让 TypeScript 4.7+ 对应子路径也能拿到独立 `.d.ts`（没有子路径 types 时，TS 仅用根 `types`，可能导致子路径类型不准确）。

要点
- 配置了 `exports` 后，大多数打包器会禁止 `import '@pkg/lib/foo'` 等“深引”，以保护公共 API 边界。
- 可按环境出不同构建，如 `browser`/`node`、`development`/`production`（需配合打包器/条件导出）。

### 2.2 types 的作用
- 指定 TypeScript 类型声明入口（全包级别）。等价字段名为 `typings`。
- 当 `exports` 未针对子路径提供 `types` 时，TypeScript 使用根级 `types`；有子路径 `types` 时，TS 4.7+ 能按子路径匹配。

示例：
```json
{
  "types": "./dist/index.d.ts"
}
```
- 在有 `exports` 子路径类型时，两者并存：根 `types` 作为默认，`exports["./sub"].types` 覆盖子路径类型入口。

建议
- 每个导出入口都应有匹配的 `.d.ts`，确保 IDE 补全与类型安全。
- 对仅运行时可用（不需类型）入口可以省略子路径 `types`。

## 3. Registry 是什么（发布到哪儿）
- Registry 是包仓库（如 npmjs 的 `https://registry.npmjs.org`、私有 Verdaccio、GitHub Packages）。
- 执行发布后，包被打包为 `.tgz` 上传到 Registry，附带包元数据（packument），Registry 更新 `dist-tags`（如 `latest`），CDN 缓存生效。
- 作用域包（如 `@platform/*`）首次发布到 npm 需 `--access public` 才能公共可见。
- 私有 Registry 需要 `.npmrc` 配置 `registry` 与 `//registry/:_authToken`。

## 4. pnpm build 之后发生了什么
- tsup（基于 esbuild）编译 TypeScript 到 ESM，并生成 `.d.ts` 和 source map：
  - 清理上次产物（`clean: true`）
  - 读取 tsconfig（如 `target: es2022`，`moduleResolution: bundler`）
  - 输出至 `dist/`（受 tsup.config 与 `outDir` 控制）
- 外部依赖按配置处理：
  - `dependencies` 通常保持为 external，不内联进产物，保持包精简与可更新。
  - `peerDependencies`（如 React/Vue）不被打进产物，要求应用侧安装。
- `files` 白名单控制实际发布内容；`exports` 定义分发映射；构建完毕后即可发布。

## 5. dist 的作用
- 承载最终分发工件：编译后的 JS、类型 `.d.ts`、source maps。
- 发布时仅上传 `dist/`（及必要文件），保证：
  - 安装体积小，隐藏源码内部结构；
  - 消费端一致加载编译后、与运行环境适配的文件；
  - `exports` 引导运行时/打包器解析到 `dist` 对应文件，`types` 引导 TS 到 `.d.ts`。
- 避免消费者直接依赖源码路径，减少“深引破坏”的风险。

## 6. 从发布到消费的全链路

开发态（Monorepo 内）
- `workspace:*`：pnpm 用符号链接将本地包“安装”到 `node_modules`。可直接 `import '@platform/*'`，无需对外发布。

发布态
1) 选择变更级别并记录：
```bash
pnpm changeset
```
2) 写版本与联动升级（把内部 `workspace:*` 解析为具体版本号）：
```bash
pnpm changeset version
```
3) 构建并发布到 Registry：
```bash
pnpm -r build
pnpm -r publish --access public
```
- 发布完成：Registry 存储 `.tgz` 与元数据，更新 `dist-tags`，CDN 生效。

消费态（外部项目）
```bash
pnpm add @platform/sdk-core @platform/sdk-http
```
- 安装阶段：客户端查询 Registry → 解析版本 → 下载 `.tgz` → 完整性校验 → 链接到 `node_modules`。
- 运行/构建阶段：
  - `exports` 决定 JS 入口（如 `import` 用 ESM）。
  - `types`/子路径 types 决定类型入口。
  - `peerDependencies` 由应用侧安装。

可选：不发布也联调
- 本地 link：
```bash
pnpm -w build
pnpm -w link --global
# 外部项目
pnpm link --global @platform/sdk-core
```
- 或使用 `file:` 依赖指向本地路径，适合短期联调。

## 7. 常见问题与建议
- 配置了 `exports` 后禁止深引：请将对外 API 整理到导出表；子路径按需白名单开放。
- 子路径类型：TS 4.7+ 支持 `exports.types`，旧版 TS 可能只读根 `types`。
- 作用域包首次发布到 npm 要 `--access public`。
- Monorepo 对外发布前务必将 `workspace:*` 变为具体版本（Changesets 自动完成）。
- `files` 白名单别忘了包含 `dist`，避免发布空包或过大。

## 8. 命令清单（本仓库）
- 安装依赖：`pnpm install`
- 全量构建：`pnpm -r build`
- 本地验证：`pnpm --filter playground dev`
- 变更记录：`pnpm changeset`
- 写版本：`pnpm changeset version`
- 发布：`pnpm -r publish --access public`（或根脚本 `pnpm release`）